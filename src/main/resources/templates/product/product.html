<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta id="loggedInproductId" th:content="${loginUserId}">
    <title>製品管理</title>
    <link rel="stylesheet" th:href="@{/css/fragment-style.css}">
    <link rel="stylesheet" th:href="@{/css/product/product.css}">
    <script th:src="@{/js/product/product.js}" defer></script>
</head>
<body>
    <div th:replace="~{fragment/fragment :: header}"></div>

    <div class="product-page-container">

        <!-- 左: 検索フォーム -->
        <div class="search-panel">
            <form action="/product/search" th:object="${searchProductForm}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <button type="submit">検索</button>
                <button type="submit" form="resetForm">リセット</button>

                <label>製品コード：
                    <input type="text" th:field="*{productCode}" placeholder="企業コード">
                </label>

                <label>製品名：
                    <input type="text" th:field="*{name}" placeholder="名前">
                </label>

                <label>所属カテゴリ：
                    <select th:field="*{categoryIds}" multiple>
                        <option value="">-- 未選択 --</option>
                        <option th:each="cat : ${categoryList}"
                                th:value="${cat.id}"
                                th:text="${cat.name}">
                        </option>
                    </select>
                </label>

                <label>保管場所：　　
                    <select th:field="*{locationIds}" multiple>
                        <option value="">-- 未選択 --</option>
                        <option th:each="loc : ${locationList}"
                                th:value="${loc.id}"
                                th:text="${loc.name}">
                        </option>
                    </select>
                </label>

                <label>在庫数
                    <input type="number" th:field="*{totalQuantityFrom}" placeholder="下限">
                    <input type="number" th:field="*{totalQuantityTo}" placeholder="上限">
                </label>

                <label>登録日：
                    <input type="date" th:field="*{createdAtFrom}">
                    <input type="date" th:field="*{createdAtTo}">
                </label>

                <label>更新日：
                    <input type="date" th:field="*{updatedAtFrom}">
                    <input type="date" th:field="*{updatedAtTo}">
                </label>
            </form>

            <!-- リセット用フォーム -->
            <form id="resetForm" action="/product/reset" method="post" style="display:none;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>

            <!-- 管理者専用ボタン -->
            <div th:if="${loginUserRole == 'ADMIN'}" class="product-actions">
                <form id="newForm" action="/product/new" method="get">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" id="newBtn">新規登録</button>
                </form>
                <form id="editForm" action="/product/edit" method="get">
                    <input type="hidden" name="productId" id="editProductId">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" id="editBtn" disabled>編集</button>
                </form>
                <form id="deleteForm" action="/product/delete" method="post">
                    <input type="hidden" name="productId" id="deleteProductId">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" id="deleteBtn" disabled>削除</button>
                </form>
            </div>
        </div>

        <!-- 右: 製品一覧 -->
        <div class="product-table">
            <table>
                <thead>
                    <tr>
                        <th>製品コード</th>
                        <th>製品名</th>
                        <th>所属カテゴリ</th>
                        <th>保管場所</th>
                        <th>在庫数</th>
                        <th>登録日</th>
                        <th>更新日</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="product : ${products}" th:data-id="${product.id}">
                        <td th:text="${product.productCode}"></td>
                        <td th:text="${product.name}"></td>

                        <!-- カテゴリ（安全なループでカンマ区切り） -->
                        <td>
                            <span th:each="c, st : ${product.categories}">
                                <span th:text="${c.name}"></span><span th:if="${!st.last}">, </span>
                            </span>
                        </td>

                        <!-- 保管場所（同様にカンマ区切り） -->
                        <td>
                            <span th:each="l, st : ${product.locations}">
                                <span th:text="${l.name}"></span><span th:if="${!st.last}">, </span>
                            </span>
                        </td>

                        <td th:text="${product.totalQuantity}"></td>

                        <td th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"></td>
                        <td th:text="${#temporals.format(product.updatedAt, 'yyyy-MM-dd')}"></td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(products)}">
                        <td colspan="7">該当する製品がありません。</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div th:replace="~{fragment/fragment :: footer}"></div>
</body>
</html>
