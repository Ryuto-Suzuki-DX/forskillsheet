<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <!--JS用 ログインユーザID取得-->
    <meta id="loggedInUserId" th:content="${loginUserId}">
    <title>ユーザー管理</title>
    <link rel="stylesheet" th:href="@{/css/fragment-style.css}">
    <link rel="stylesheet" th:href="@{/css/user/user.css}">
    <script th:src="@{/js/user/user.js}" defer></script>
</head>
<body>
    <!--ヘッダー-->
    <div th:replace="~{fragment/fragment :: header}"></div>

    <div class="user-page-container">
        <!-- 左: 検索フォーム -->
        <div class="user-search-panel">
            <form action="/user/search" th:object="${searchUserForm}" method="post">
                <!--CSRFトークン-->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <button type="submit">検索</button>
                <button type="submit" form="resetForm">リセット</button>

                <label>ユーザーID：
                    <input type="text" th:field="*{id}" placeholder="ユーザーID"
                        inputmode="numeric" pattern="[0-9]*"
                        oninput="this.value = this.value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '')">
                </label>
                <label>ユーザー名：
                    <input type="text" th:field="*{username}" placeholder="ユーザー名">
                </label>
                <label>名前：
                    <input type="text" th:field="*{name}" placeholder="名前">
                </label>
                <label>権限：
                    <select th:field="*{role}">
                        <option value="" selected>未指定</option>
                        <option value="ADMIN">管理者</option>
                        <option value="GENERAL">一般</option>
                    </select>
                </label>
                <label>登録日：
                    <input type="date" th:field="*{createdAtFrom}" placeholder="登録日～">
                    <input type="date" th:field="*{createdAtTo}" placeholder="～登録日">
                </label>
                <label>更新日：
                    <input type="date" th:field="*{updatedAtFrom}" placeholder="更新日～">
                    <input type="date" th:field="*{updatedAtTo}" placeholder="～更新日">
                </label>
            </form>

            <!--リセット用フォーム-->
            <form id="resetForm" action="/user/reset" method="post" style="display:none;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>

            <!--管理者(ADMIN)専用ボタン-->
            <div th:if="${loginUserRole == 'ADMIN'}" class="user-actions">

                <!--新規作成ボタン-->
                <form id="newForm" action="/user/new" method="get">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" id="newBtn">新規登録</button>
                </form>

                <!--編集ボタン-->
                <form id="editForm" action="/user/edit" method="get">
                    <input type="hidden" name="userId" id="editUserId">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" id="editBtn" disabled>編集</button>
                </form>

                <!--削除ボタン-->
                <form id="deleteForm" action="/user/delete" method="post">
                    <input type="hidden" name="userId" id="deleteUserId">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" disabled id="deleteBtn">削除</button>
                </form>
            </div>
        </div>

        <!-- 右: テーブル -->
        <div class="user-table">
            <table>
                <tr>
                    <th>ユーザーID</th>
                    <th>ユーザー名</th>
                    <th>名前</th>
                    <th>権限</th>
                    <th>登録日</th>
                    <th>更新日</th>
                </tr>
                <!--ユーザー一覧-->
                <tr th:each="user : ${users}" th:data-id="${user.id}">
                    <td th:text="${user.id}"></td>
                    <td th:text="${user.username}"></td>
                    <td th:text="${user.name}"></td>
                    <td th:text="${user.role == 'ADMIN' ? '管理者' : '一般'}"></td>
                    <td th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd')}"></td>
                    <td th:text="${#temporals.format(user.updatedAt, 'yyyy-MM-dd')}"></td>
                </tr>
                <!--空メッセージ-->
                <tr th:if="${#lists.isEmpty(users)}">
                    <td colspan="6">該当するユーザーがいません。</td>
                </tr>
            </table>
        </div>
    </div>

    <!--フッター-->
    <div th:replace="~{fragment/fragment :: footer}"></div>
</body>
</html>
