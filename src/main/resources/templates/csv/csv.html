<!-- src/main/resources/templates/csv/csv.html -->
<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>入出庫 CSV一括登録</title>
  <link rel="stylesheet" th:href="@{/css/fragment-style.css}">
  <link rel="stylesheet" th:href="@{/css/csv/csv.css}">
</head>
<body>
  <div th:replace="~{fragment/fragment :: header}"></div>

  <!-- 管理者のみ表示 -->
  <main class="csv-root" sec:authorize="hasRole('ADMIN')">
    <h1 style="font-size:14px; margin:4px 0 8px; color:#EEE8E1;">入出庫 CSV一括登録</h1>

    <div class="csv-page-container">
      <!-- 左：アップロード・アクション -->
      <section class="csv-panel">
        <h2>CSV アップロード</h2>
        <form th:action="@{/csv/import}" method="post" enctype="multipart/form-data">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

          <label>CSVファイル：
            <input type="file" name="file" accept=".csv" required>
          </label>

          <p class="csv-hint">
            同じ <code>import_key</code> の行が1つの注文になります。全件成功のみ登録されます。
          </p>

          <button class="csv-btn" type="submit" style="margin-top:6px;">取り込み</button>
        </form>

        <div class="csv-sub-actions">
          <a th:href="@{/csv/sample}" class="csv-link-btn">サンプルCSVをダウンロード</a>
          <a th:href="@{/order/search}" class="csv-link-btn">入出庫一覧へ</a>
        </div>

        <div class="csv-note">
          ・1回の取り込みは「全件成功時のみ確定」<br>
          ・取り込み前にCSVの文字コードはUTF-8を推奨<br>
          ・ヘッダー行必須、列順固定（サンプル参照）
        </div>
      </section>

      <!-- 右：結果／エラー（独立スクロール） -->
      <section class="csv-content">
        <div class="csv-scroll">

          <!-- エラー表示（テーブル） -->
          <div class="csv-card" th:if="${errors != null}">
            <h2>エラー</h2>
            <table class="csv-table" th:if="${#lists.size(errors) > 0}">
              <thead>
                <tr>
                  <th style="width:80px;">行</th>
                  <th>内容</th>
                </tr>
              </thead>
              <tbody>
                <!-- errors が "行番号とメッセージ" の文字列配列ならそのまま表示 -->
                <!-- もし Map<Integer,String> のような構造場合は適宜 th:each を調整 -->
                <tr th:each="e, stat : ${errors}">
                  <td th:text="${stat.index + 1}"></td>
                  <td th:text="${e}"></td>
                </tr>
              </tbody>
            </table>
            <p class="csv-hint" style="margin-top:8px;">※エラーがあるため、登録は一切行われていません。</p>
          </div>

          <!-- 成功結果 -->
          <div class="csv-card" th:if="${result != null}">
            <h2>結果</h2>
            <p th:text="${result}"></p>
          </div>

          <!-- 何もない時のガイド -->
          <div class="csv-card" th:if="${errors == null and result == null}">
            <h2>ガイド</h2>
            <p class="csv-hint">左の「CSV アップロード」からファイルを選択し、取り込みを実行してください。</p>
          </div>

        </div>
      </section>
    </div>
  </main>

  <!-- 非管理者への案内 -->
  <div class="access-guard" sec:authorize="!hasRole('ADMIN')">
    <p>このページは管理者のみ利用できます。</p>
  </div>
</body>
</html>
