<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <!--JS用 ログインユーザID取得-->
    <meta id="loggedInUserId" th:content="${loginUserId}">
    <title>入出庫管理</title>
    <link rel="stylesheet" th:href="@{/css/fragment-style.css}">
    <link rel="stylesheet" th:href="@{/css/order/order.css}">
    <script th:src="@{/js/order/order.js}" defer></script>
</head>
<body>
    <!--ヘッダー-->
    <div th:replace="~{fragment/fragment :: header}"></div>

    <div class="order-page-container">

        <!-- 左: 検索フォーム -->
        <div class="search-panel">
            <form action="/order/search" th:object="${searchOrderForm}" method="post">
                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="form-actions-top">
                    <button type="submit">検索</button>
                    <button type="submit" form="resetForm">リセット</button>
                </div>

                <!-- ID（非表示） -->
                <input type="hidden" th:field="*{id}">

                <!-- 基本項目 -->
                <label>入出庫コード：
                    <input type="text" th:field="*{orderCode}" placeholder="例：IN-2025-0001">
                </label>
                <label>企業コード：
                    <input type="text" th:field="*{partyCode}" placeholder="例：C-00123">
                </label>
                <label>企業名：
                    <input type="text" th:field="*{partyName}" placeholder="例：株式会社サンプル">
                </label>
                <label>伝票番号：
                    <input type="text" th:field="*{trackingNumber}" placeholder="例：SAGAWA123456">
                </label>
                <label>配送日：
                    <input type="date" th:field="*{deliveryDate}" placeholder="例：2025-01-01">
                </label>

                <!-- 担当者（名称で部分一致） -->
                <label>オーダー作成者名：
                    <input type="text" th:field="*{adminName}" placeholder="例：山田太郎">
                </label>
                <label>検品者名：
                    <input type="text" th:field="*{qualityInspectorName}" placeholder="例：佐藤花子">
                </label>
                <label>入出庫者名：
                    <input type="text" th:field="*{warehouseWorkerName}" placeholder="例：田中一郎">
                </label>

                <!-- コメント系 -->
                <label>申し送り：
                    <textarea th:field="*{adminNote}" placeholder="キーワードで検索"></textarea>
                </label>
                <label>検品時コメント：
                    <textarea th:field="*{qualityInspectorNote}" placeholder="キーワードで検索"></textarea>
                </label>
                <label>入出荷時コメント：
                    <textarea th:field="*{warehouseWorkerNote}" placeholder="キーワードで検索"></textarea>
                </label>

                <!-- ロケーション（名称で部分一致） -->
                <label>一時保管場所名：
                    <input type="text" th:field="*{locationName}" placeholder="例：第1倉庫A-1">
                </label>

                <!-- 製品名（EXISTSで絞り込み） -->
                <label>製品名1：
                    <input type="text" th:field="*{productName1}" placeholder="製品名の部分一致">
                </label>
                <label>製品名2：
                    <input type="text" th:field="*{productName2}" placeholder="製品名の部分一致">
                </label>
                <!-- 状況 -->
                <label>状況：
                    <select th:field="*{situation}">
                        <option value="">全て</option>
                        <option value="配送待ち">配送待ち</option>
                        <option value="作業中">作業中</option>
                        <option value="検品中">検品中</option>
                        <option value="検品待ち">検品待ち</option>
                        <option value="保留中">保留中</option>
                        <option value="完了">完了</option>
                        <option value="キャンセル">キャンセル</option>
                        <option value="その他">その他</option>
                    </select>
                </label>
                <!-- 画像の有無 -->
                <label>画像の有無：
                    <select th:field="*{hasImage}">
                        <option value="">全て</option>
                        <option value="true">あり</option>
                        <option value="false">なし</option>
                    </select>
                </label>
                <label>CSV登録：
                    <select th:field="*{howCsv}">
                        <option value="">全て</option>
                        <option value="false">CSV以外での登録のみ</option>
                        <option value="true">CSVでの登録のみ</option>
                    </select>
                </label>
                <!-- 日付範囲 -->
                <label>登録日：
                    <input type="date" th:field="*{createdAtFrom}" placeholder="登録日～">
                    <input type="date" th:field="*{createdAtTo}" placeholder="～登録日">
                </label>
                <label>更新日：
                    <input type="date" th:field="*{updatedAtFrom}" placeholder="更新日～">
                    <input type="date" th:field="*{updatedAtTo}" placeholder="～更新日">
                </label>
            </form>

            <!-- リセット用 -->
            <form id="resetForm" action="/order/reset" method="post" style="display:none;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>


            <div class="order-actions">
                <!-- 編集 -->
                <form id="editForm" action="/order/edit" method="get">
                    <input type="hidden" name="orderId" id="editOrderId">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" id="editBtn" disabled>編集</button>
                </form>
            </div>

            <!-- 管理者(ADMIN)専用ボタン（JSで選択行に応じて活性/非活性） -->
            <div th:if="${loginUserRole == 'ADMIN'}" class="order-actions">
                <!-- 新規登録はなし別画面実装 -->
                <!-- 削除 -->
                <form id="deleteForm" action="/order/delete" method="post">
                    <input type="hidden" name="orderId" id="deleteOrderId">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" id="deleteBtn" disabled>削除</button>
                </form>
            </div>
            <div th:if="${deleteFailed}" class="error-message">
                <p style="color:red;">完了状態や、存在しない入出庫は削除できません。</p>
            </div>
        </div>

        <!-- 右: テーブル -->
        <div class="order-table">
            <table>
                <thead>
                    <tr>
                        <th>入出庫コード</th>
                        <th>企業コード</th>
                        <th>企業名</th>
                        <th>伝票番号</th>
                        <th>配送日</th>
                        <th>登録日</th>
                        <th>更新日</th>
                        <th>状況</th>
                        <th>検品対応者</th>
                        <th>入出庫対応者</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JSの選択機能用に data-id を付与 -->
                    <tr th:each="order : ${orders}" th:data-id="${order.id}">
                        <td th:text="${order.orderCode}"></td>
                        <td th:text="${order.partyCode}"></td>
                        <td th:text="${order.partyName}"></td>
                        <td th:text="${order.trackingNumber}"></td>
                        <td th:text="${#temporals.format(order.deliveryDate, 'yyyy-MM-dd')}"></td>
                        <td th:text="${#temporals.format(order.createdAt, 'yyyy-MM-dd')}"></td>
                        <td th:text="${#temporals.format(order.updatedAt, 'yyyy-MM-dd')}"></td>
                        <td th:text="${order.situation}"></td>
                        <td th:text="${order.qualityInspectorName}"></td>
                        <td th:text="${order.warehouseWorkerName}"></td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(orders)}">
                        <td colspan="10">該当する入出庫がありません。</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div th:replace="~{fragment/fragment :: footer}"></div>
</body>
</html>
