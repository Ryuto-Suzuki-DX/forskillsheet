<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title th:text="${mode == 'OUT'} ? '出庫 新規作成' : '入庫 新規作成'">入出庫 新規作成</title>
  <link rel="stylesheet" th:href="@{/css/fragment-style.css}">
  <link rel="stylesheet" th:href="@{/css/order/edit.css}">
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}">
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}">
  <script th:src="@{/js/order/new-inout.js}" defer></script>
</head>

<script th:inline="javascript">
  /*<![CDATA[*/
  const partyList = /*[[${partyList}]]*/ || [];
  /*]]>*/
</script>

<body>
  <!-- 共通ヘッダー -->
  <div th:replace="~{fragment/fragment :: header}"></div>

  <div class="edit-root" sec:authorize="hasRole('ADMIN')">
    <h1 class="page-title" th:text="${mode == 'OUT'} ? '出庫 新規作成' : '入庫 新規作成'">入出庫 新規作成</h1>

    <form class="order-form"
          th:action="${mode == 'OUT'} ? @{/order-out/save} : @{/order-in/save}"
          method="post"
          th:object="${orderWithDetailsDto}"
          th:attr="data-mode=${mode != null ? mode : 'IN'}">

      <!-- CSRF / ID -->
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <input type="hidden" th:field="*{id}" />

      <div class="screen">
        <!-- ========== 上段：左=入力 / 右=登録予定製品 ========== -->
        <section class="block block-top">
          <!-- 左：入力 -->
          <div class="block-left">
            <!-- 基本情報 -->
            <div class="form-grid">
              <p th:text="${mode == 'OUT'} ? '出庫コードは自動採番' : '入庫コードは自動採番'"></p>

              <label>企業コード：
                <input type="text" id="partyCode" th:field="*{partyCode}" required>
              </label>

              <label>企業名：
                <input type="text" id="partyName" th:field="*{partyName}" required>
                <input type="hidden" id="partyIdHidden" th:field="*{partyId}">
              </label>

              <label>伝票番号:
                <input type="text" th:field="*{trackingNumber}">
              </label>

              <label>納品/配送日:
                <input type="date" th:field="*{deliveryDate}" required>
              </label>

              <label>状況:
                <select th:field="*{situation}">
                  <option value="">-- 未選択 --</option>
                  <option value="配送待ち">配送待ち</option>
                  <option value="作業中">作業中</option>
                  <option value="検品中">検品中</option>
                  <option value="検品待ち">検品待ち</option>
                  <option value="保留中">保留中</option>
                  <option value="完了">完了</option>
                  <option value="キャンセル">キャンセル</option>
                  <option value="その他">その他</option>
                </select>
              </label>
            </div>

            <!-- 担当者 -->
            <div class="form-grid">
              <label>管理者:
                <select th:field="*{adminId}">
                  <option th:each="admin : ${adminList != null ? adminList : #lists.arrayList()}"
                          th:value="${admin.id}"
                          th:text="${admin.name}">管理者</option>
                </select>
              </label>

              <label>作業者:
                <select th:field="*{warehouseWorkerId}">
                  <option value="">-- 未選択 --</option>
                  <option th:each="worker : ${warehouseWorkerList != null ? warehouseWorkerList : #lists.arrayList()}"
                          th:value="${worker.id}"
                          th:text="${worker.name}">作業者</option>
                </select>
              </label>

              <label>検品者:
                <select th:field="*{qualityInspectorId}">
                  <option value="">-- 未選択 --</option>
                  <option th:each="inspector : ${qualityInspectorList != null ? qualityInspectorList : #lists.arrayList()}"
                          th:value="${inspector.id}"
                          th:text="${inspector.name}">検品者</option>
                </select>
              </label>

              <label>保管場所：
                <select th:field="*{locationId}">
                  <option value="">-- 未選択 --</option>
                  <option th:each="loc : ${locationList != null ? locationList : #lists.arrayList()}"
                          th:value="${loc.id}"
                          th:text="${loc.name}">場所</option>
                </select>
              </label>
            </div>

            <!-- 備考 + 添付画像ボタン（★追加） -->
            <div class="form-grid">
              <label>管理者メモ:
                <textarea th:field="*{adminNote}"></textarea>
              </label>
              <label>検品者メモ:
                <textarea th:field="*{qualityInspectorNote}"></textarea>
              </label>
              <label>作業者メモ:
                <textarea th:field="*{warehouseWorkerNote}"></textarea>
              </label>

              <!-- 新規でも画像添付モーダルを開ける（権限に合わせて表示） -->
              <button type="button" id="openOrderImageModal" class="img-btn"
                      sec:authorize="hasRole('ADMIN')">添付画像</button>
            </div>

            <!-- ボタン -->
            <div class="button-row">
              <button type="submit" class="btn btn-primary"
                      th:text="${mode == 'OUT'} ? '出庫として登録' : '入庫として登録'">登録</button>
              <a th:href="@{/order/search}" class="btn btn-secondary">戻る</a>
            </div>
          </div>

          <!-- 右：登録予定製品（内部スクロール） -->
          <aside class="block-right">
            <div class="product-section">
              <div class="section-titlebar"><h2>登録製品</h2></div>
              <div class="scrollable-table fill-scroll">
                <table>
                  <thead>
                    <tr>
                      <th>製品コード</th>
                      <th>製品名</th>
                      <th>カテゴリ</th>
                      <th>管理場所</th>
                      <th>数量</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="selectedProducts">
                    <tr th:each="p, st : ${ (orderWithDetailsDto != null and orderWithDetailsDto.productWithDetailsDtos != null) ? orderWithDetailsDto.productWithDetailsDtos : #lists.arrayList() }"
                        th:attr="data-id=${p != null ? p.id : null}">
                      <td>
                        <span th:text="${p != null ? p.productCode : ''}"></span>
                        <input type="hidden" th:field="*{productWithDetailsDtos[__${st.index}__].id}" />
                        <input type="hidden" th:field="*{productWithDetailsDtos[__${st.index}__].productCode}" />
                      </td>
                      <td>
                        <span th:text="${p != null ? p.name : ''}"></span>
                        <input type="hidden" th:field="*{productWithDetailsDtos[__${st.index}__].name}" />
                      </td>
                      <td>
                        <span th:if="${p == null or #lists.isEmpty(p.categories)}">-</span>
                        <span th:unless="${p == null or #lists.isEmpty(p.categories)}" th:remove="tag">
                          <span th:each="c, cs : ${p.categories}">
                            <span th:text="${c.name}"></span><span th:if="${!cs.last}">, </span>
                          </span>
                        </span>
                      </td>
                      <td>
                        <span th:if="${p == null or #lists.isEmpty(p.locations)}">-</span>
                        <span th:unless="${p == null or #lists.isEmpty(p.locations)}" th:remove="tag">
                          <span th:each="l, ls : ${p.locations}">
                            <span th:text="${l.name}"></span><span th:if="${!ls.last}">, </span>
                          </span>
                        </span>
                      </td>
                      <td>
                        <input type="number" th:field="*{productWithDetailsDtos[__${st.index}__].quantity}" min="1" required/>
                      </td>
                      <td>
                        <button type="button" class="remove-btn">削除</button>
                      </td>
                    </tr>
                    <!-- 以降は JS で追加 -->
                  </tbody>
                </table>
              </div>
            </div>
          </aside>
        </section>

        <!-- ========== 下段：左=製品検索 / 右=検索結果 ========== -->
        <section class="block block-bottom">
          <div class="block-left">
            <div class="product-section">
              <h3>製品検索</h3>
              <div class="search-form form-grid">
                <input type="text" id="searchKeyword" placeholder="製品名を入力">
                <select id="searchCategory">
                  <option value="">カテゴリを選択</option>
                  <option th:each="cat : ${categoryList != null ? categoryList : #lists.arrayList()}"
                          th:value="${cat.id}" th:text="${cat.name}">カテゴリ</option>
                </select>
                <select id="searchLocation">
                  <option value="">管理場所を選択</option>
                  <option th:each="loc : ${locationList != null ? locationList : #lists.arrayList()}"
                          th:value="${loc.id}" th:text="${loc.name}">場所</option>
                </select>
                <button type="button" id="searchProductBtn" class="img-btn">検索</button>
              </div>
            </div>
          </div>

          <aside class="block-right">
            <div class="product-section">
              <h3>検索結果</h3>
              <div class="scrollable-table fill-scroll">
                <table id="searchResultsTable">
                  <thead>
                    <tr>
                      <th>製品コード</th>
                      <th>製品名</th>
                      <th>カテゴリ</th>
                      <th>管理場所</th>
                      <th>在庫数</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody><!-- JS で描画 --></tbody>
                </table>
              </div>
            </div>
          </aside>
        </section>
      </div>
    </form>
  </div>


  <!-- ★ 一般ユーザー：アクセス拒否カード -->
  <div class="access-guard" sec:authorize="!hasRole('ADMIN')" role="region" aria-labelledby="guardTitle">
    <div class="guard-card">
      <div class="guard-icon" aria-hidden="true">🔒</div>
      <h1 id="guardTitle">このページは管理者（ADMIN）のみ利用できます</h1>
      <p class="guard-msg">
        権限がないため、入出庫の新規作成・編集は行えません。必要な場合は管理者にお問い合わせください。
      </p>
      <div class="guard-actions">
        <a th:href="@{/order/search}" class="btn btn-secondary">入出庫一覧へ戻る</a>
        <a th:href="@{/home}" class="btn btn-primary">トップへ</a>
      </div>
    </div>
  </div>

  <!-- ===== 画像モーダル（★新規にも追加） ===== -->
  <div id="orderImageModal" class="image-modal" aria-hidden="true" sec:authorize="hasRole('ADMIN')">
    <div class="image-modal__backdrop"></div>
    <div class="image-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="orderImageModalTitle">
      <div class="image-modal__header">
        <h3 id="orderImageModalTitle">注文画像</h3>
        <button type="button" class="image-modal__close" aria-label="閉じる">&times;</button>
      </div>

      <div class="image-modal__uploader">
        <input type="file" id="op-file" accept="image/*" multiple>
        <button type="button" id="op-upload" class="img-btn">アップロード</button>
        <small>複数選択可（PNG/JPG/WebPなど）</small>
      </div>

      <div class="image-modal__list">
        <div class="scrollable-table fill-scroll">
          <table>
            <thead>
              <tr>
                <th style="width:120px;">サムネイル</th>
                <th>URL</th>
                <th style="width:72px;"></th>
              </tr>
            </thead>
            <tbody id="op-list"><!-- JSで埋める --></tbody>
          </table>
        </div>
      </div>

      <div class="image-modal__footer">
        <button type="button" class="img-btn image-modal__close">閉じる</button>
      </div>
    </div>
  </div>
</body>
</html>
